<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Emergency Contact Portal</title>
  <style>
    :root{
      --bg:#F8FAFC;
      --card:#FFFFFF;
      --muted:#6B7280;
      --border:#E5E7EB;
      --accent:#111827;
      --accent-weak:#374151;
      --pill:#F3F4F6;
      --radius:14px;
    }

    html,body{height:100%;}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial; background:var(--bg); margin:0; color:var(--accent)}
    .wrap{max-width:980px; margin:28px auto; padding:20px}

    /* Header */
    .portal-header{display:flex;align-items:center;gap:12px;margin-bottom:18px}
    .logo{width:56px;height:56px;border-radius:12px;background:linear-gradient(135deg,#EFF6FF,#F8FAFC);display:flex;align-items:center;justify-content:center;border:1px solid var(--border);box-shadow:0 6px 18px rgba(2,6,23,0.06)}
    .logo svg{width:34px;height:34px;fill:var(--accent)}
    .hdr-title{display:flex;flex-direction:column}
    .hdr-title h1{font-size:20px;margin:0;font-weight:800}
    .hdr-sub{font-size:13px;color:var(--muted);margin-top:4px}

    .card{background:var(--card); border:1px solid var(--border); border-radius:var(--radius); padding:18px; margin-bottom:16px; box-shadow:0 6px 18px rgba(2,6,23,0.04)}
    h2{font-size:15px;margin:8px 0 12px;font-weight:800;color:var(--accent)}
    label{display:block;font-weight:700;color:var(--accent-weak);margin:6px 0 6px}
    input,textarea{width:100%;padding:12px;border-radius:10px;border:1px solid #E6E9EE;background:#fbfdff;font-size:14px;color:var(--accent);box-sizing:border-box}
    textarea{min-height:88px}

    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}

    .btn{background:var(--accent);color:#fff;font-weight:800;border:none;border-radius:10px;padding:10px 14px;cursor:pointer;box-shadow:0 6px 14px rgba(17,24,39,0.12);transition:transform .08s ease,box-shadow .08s ease}
    .btn:active{transform:translateY(1px)}
    .btn.secondary{background:transparent;color:var(--accent);border:1px solid rgba(17,24,39,0.08);box-shadow:none}
    .btn.ghost{background:transparent;border:1px dashed rgba(17,24,39,0.08);color:var(--accent)}

    .chip{border:1px solid #E2E8F0;padding:8px 12px;border-radius:999px;cursor:pointer;user-select:none;font-weight:800;display:inline-block;margin:4px 6px 0 0;background:transparent}
    .chip.active{background:var(--accent);color:#fff;border-color:var(--accent)}
    .medrow{display:flex;gap:8px;margin-top:6px}
    .ghost{background:transparent;border:1px dashed rgba(17,24,39,0.06);color:var(--accent)}
    .muted{color:var(--muted);font-size:13px}

    /* Save area on mobile */
    .actions{display:flex;justify-content:flex-end;gap:12px;align-items:center}
    @media (max-width:640px){
      .wrap{padding:14px;margin:16px}
      .actions{position:sticky;bottom:12px;background:transparent;padding:6px 0}
      .card:last-of-type{padding-bottom:74px}
    }

    /* subtle helpers */
    input::placeholder, textarea::placeholder{color:#9CA3AF}
  </style>
</head>
<body>
<div class="wrap">
  <div class="portal-header">
    <div class="logo" aria-hidden>
      <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 2a4 4 0 0 0-4 4v2H6a4 4 0 0 0-4 4v4a4 4 0 0 0 4 4h12a4 4 0 0 0 4-4v-4a4 4 0 0 0-4-4h-2V6a4 4 0 0 0-4-4zM8 8a4 4 0 1 1 8 0v2H8V8z"/></svg>
    </div>
    <div class="hdr-title">
      <h1>Emergency Contact Portal</h1>
      <div class="hdr-sub">Quickly view and update emergency contact & medical details</div>
    </div>
  </div>

    <div class="card">
    <p class="muted" id="status">Loading…</p>
    <!-- token input shown when portal is opened without ?token=... -->
    <div id="tokenBlock" style="display:none; margin-top:8px">
      <div style="display:flex; gap:8px; align-items:center">
        <input id="tokenInput" placeholder="Paste token from app link (e.g. ?token=...)" />
        <button id="tokenBtn" class="btn">Open</button>
      </div>
      <p id="tokenMsg" class="muted"></p>
    </div>
    <div id="pinBlock" style="display:none">
      <div style="display:flex; gap:8px; align-items:center">
        <input id="pinInput" placeholder="Enter 4+ digit PIN" />
        <button id="pinSetBtn" class="btn">Set PIN</button>
        <button id="pinUseBtn" class="btn secondary">Unlock</button>
      </div>
      <p id="pinMsg" class="muted"></p>
    </div>
  </div>

  <div id="main" style="display:none">
    <div class="card">
      <h2>Emergency Contact</h2>
      <label>Name</label><input id="ec_name" />
      <label>Relation</label><input id="ec_relation" />
      <label>Phone</label><input id="ec_phone" />
      <label>Email</label><input id="ec_email" />
    </div>

    <div class="card">
      <h2>Health Card</h2>
      <label>Drug allergy</label><input id="drug_allergies" placeholder="e.g. Penicillin or NIL" />
      <label>Assistive needs</label>
      <div id="assistive"></div>
      <div id="assistive_other_wrap" style="display:none">
        <label>Other</label><input id="assistive_other" placeholder="Type other assistive need" />
      </div>
      <label>Note to public</label><textarea id="public_note" placeholder="If found lost, please call …"></textarea>
    </div>

    <div class="card">
      <h2>Conditions & Medications</h2>

      <div class="row" style="margin-bottom:8px">
        <span id="noCondsChip" class="chip">No conditions</span>
        <span class="muted">Tip: you can still add a condition even if this is on — the form will auto-reappear.</span>
      </div>

      <div id="noCondsNote" class="muted" style="display:none; margin-bottom:8px">
        You marked “No conditions”. We will save a single NIL placeholder. You can still add a condition below.
      </div>

      <div id="conds"></div>

      <button id="addCond" class="btn ghost" style="margin-top:8px">+ Add condition</button>
    </div>

    <div class="card">
      <button id="saveBtn" class="btn">Save changes</button>
      <span id="saveMsg" class="muted" style="margin-left:8px"></span>
    </div>
  </div>
</div>

<script type="module">
  import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

  const PROJECT_URL = "https://ilwcrkwdmzfwoyjknrkl.supabase.co";
  const ANON_KEY    = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imlsd2Nya3dkbXpmd295amtucmtsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcwNjQ3MTcsImV4cCI6MjA3MjY0MDcxN30.SMXOZoShZ7pNd4fNF8PwyevLj0SjLXALaoF8H8ZwOi4";
  const supabase = createClient(PROJECT_URL, ANON_KEY);

  let token = new URLSearchParams(location.search).get('token') || '';
  const assistiveKeys = ['walking_cane','wheelchair','hearing_aid','glasses','other'];
  const labels = { walking_cane:'Walking Cane', wheelchair:'Wheelchair', hearing_aid:'Hearing Aid', glasses:'Glasses', other:'Other' };
  const el = id => document.getElementById(id);

  const NIL_MED  = { name:'NIL', frequency:'NIL' };
  const NIL_COND = { condition:'NIL', doctor:'NIL', clinic:'NIL', appointments:'NIL', medications:[{...NIL_MED}] };

  let noConditions = false;

  function chip(parent, key, active) {
    const span = document.createElement('span');
    span.className = 'chip' + (active ? ' active':'');
    span.textContent = labels[key];
    span.onclick = () => {
      span.classList.toggle('active');
      if (key==='other') document.getElementById('assistive_other_wrap').style.display =
        span.classList.contains('active') ? '' : 'none';
    };
    parent.appendChild(span);
  }

  function medRow(m={name:'',frequency:''}) {
    const row = document.createElement('div');
    row.className='medrow';
    const n = document.createElement('input'); n.placeholder='Medication name'; n.value=m.name||'';
    const f = document.createElement('input'); f.placeholder='Frequency (e.g., 1 tab AM/PM)'; f.value=m.frequency||'';
    const rm= document.createElement('button'); rm.textContent='Remove'; rm.className='btn secondary'; rm.onclick=()=>row.remove();
    row.append(n,f,rm);
    return row;
  }

  // Per-condition block
  function condBlock(c={condition:'',doctor:'',clinic:'',appointments:'', medications:[{name:'',frequency:''}]}) {
    const wrap = document.createElement('div'); wrap.className='card';

    const t=document.createElement('input'); t.placeholder='Condition (e.g., Diabetes)'; t.value=c.condition||'';
    const d=document.createElement('input'); d.placeholder='Doctor'; d.value=c.doctor||'';
    const cl=document.createElement('input'); cl.placeholder='Clinic/Hospital'; cl.value=c.clinic||'';
    const ap=document.createElement('textarea'); ap.placeholder='Appointment notes'; ap.value=c.appointments||'';

    const togglesRow = document.createElement('div'); togglesRow.className='row';
    const noMedsChip = document.createElement('span'); noMedsChip.className='chip'; noMedsChip.textContent='No medications for this condition';
    togglesRow.appendChild(noMedsChip);

    const medsLabel=document.createElement('label'); medsLabel.textContent='Medications';
    const medsWrap=document.createElement('div');

    const addMedBtn = document.createElement('button');
    addMedBtn.className = 'btn ghost';
    addMedBtn.textContent = '+ Add medication';
    addMedBtn.style.marginTop = '6px';
    addMedBtn.onclick = () => medsWrap.appendChild(medRow({name:'',frequency:''}));

    const initialNoMeds = Array.isArray(c.medications)
      && c.medications.length===1
      && String(c.medications[0]?.name).toUpperCase()==='NIL';

    if (c.medications?.length && !initialNoMeds) {
      c.medications.forEach(m=> medsWrap.appendChild(medRow(m)));
    } else if (!initialNoMeds) {
      medsWrap.appendChild(medRow({name:'',frequency:''}));
    }

    function setNoMeds(on) {
      if (on) {
        noMedsChip.classList.add('active');
        medsLabel.style.display='none';
        medsWrap.style.display='none';
        addMedBtn.style.display='none';
      } else {
        noMedsChip.classList.remove('active');
        medsLabel.style.display='';
        medsWrap.style.display='';
        addMedBtn.style.display='';
        if (medsWrap.children.length===0) medsWrap.appendChild(medRow({name:'',frequency:''}));
      }
    }
    setNoMeds(initialNoMeds);
    noMedsChip.onclick = ()=> setNoMeds(!noMedsChip.classList.contains('active'));

    const rmC=document.createElement('button'); rmC.textContent='Remove condition'; rmC.className='btn secondary'; rmC.style.marginTop='6px'; rmC.onclick=()=>wrap.remove();

    wrap.append(t,d,cl,ap,togglesRow,medsLabel,medsWrap,addMedBtn,rmC);

    wrap._get=()=>({
      condition: t.value.trim()||null,
      doctor: d.value.trim()||null,
      clinic: cl.value.trim()||null,
      appointments: ap.value.trim()||null,
      medications: noMedsChip.classList.contains('active')
        ? [{...NIL_MED}]
        : [...medsWrap.children].map(r=>{
            const [n,f]=r.querySelectorAll('input');
            const name=(n.value||'').trim();
            const frequency=(f.value||'').trim();
            return name ? { name, frequency: frequency||null } : null;
          }).filter(Boolean)
    });

    return wrap;
  }

  async function sha256Hex(s) {
    const b = new TextEncoder().encode(s);
    const h = await crypto.subtle.digest('SHA-256', b);
    return [...new Uint8Array(h)].map(x=>x.toString(16).padStart(2,'0')).join('');
  }

  async function rpcGet(pinHash) {
    const { data, error } = await supabase.rpc('ec_get_portal', { p_token: token, p_pin_hash: pinHash });
    return { data, error };
  }
  async function rpcSetPin(pinHash) {
    const { data, error } = await supabase.rpc('ec_set_pin', { p_token: token, p_pin_hash: pinHash });
    return { data, error };
  }
  async function rpcSave(pinHash, payload) {
    const { data, error } = await supabase.rpc('ec_save_portal', {
      p_token: token,
      p_pin_hash: pinHash,
      p_emergency: payload.emergency,
      p_extras: payload.extras,
      p_conditions: payload.conditions
    });
    return { data, error };
  }

  function gatherAssistive() {
    const picks = [...document.querySelectorAll('#assistive .chip.active')].map(ch=> {
      const label = ch.textContent;
      const key = Object.entries(labels).find(([,v])=>v===label)?.[0] || label;
      return key;
    });
    if (picks.includes('other')) {
      const other = el('assistive_other').value.trim();
      if (other) picks.push('other:'+other);
      return picks.filter(p=>p!=='other');
    }
    return picks;
  }

  function setNoConditionsUI(on) {
    noConditions = !!on;
    el('noCondsNote').style.display = on ? '' : 'none';
    el('conds').style.display = on ? 'none' : '';
    el('noCondsChip').classList.toggle('active', on);
  }

  function getEmergency(profile = {}) {
    if (profile.emergency && typeof profile.emergency === 'object') {
      const e = profile.emergency;
      return {
        name:     e.name ?? '',
        relation: e.relation ?? '',
        phone:    e.phone ?? '',
        email:    e.email ?? ''
      };
    }
    return {
      name:     profile.emergency_name ?? '',
      relation: profile.emergency_relation ?? '',
      phone:    profile.emergency_phone ?? '',
      email:    profile.emergency_email ?? ''
    };
  }

  function render(resp) {
    console.log('RPC payload:', resp);

    el('status').textContent='';
    el('main').style.display='';

    const payload    = Array.isArray(resp) ? (resp[0] || {}) : (resp || {});
    const profile    = payload.profile || {};
    const conditions = Array.isArray(payload.conditions) ? payload.conditions : [];

    // Emergency contact
    const em = getEmergency(profile);
    el('ec_name').value     = em.name || '';
    el('ec_relation').value = em.relation || '';
    el('ec_phone').value    = em.phone || '';
    el('ec_email').value    = em.email || '';

    // Extras
    el('drug_allergies').value = profile.drug_allergies || '';
    el('public_note').value    = profile.public_note || '';
    const needs = Array.isArray(profile.assistive_needs) ? profile.assistive_needs : [];
    const showOther = needs.some(v=>String(v).startsWith('other:'));
    const assistDiv = el('assistive'); assistDiv.innerHTML='';
    assistiveKeys.forEach(k=>{
      const active = k==='other' ? showOther : needs.includes(k);
      chip(assistDiv, k, active);
    });
    el('assistive_other_wrap').style.display = showOther ? '' : 'none';
    el('assistive_other').value = showOther
      ? String(needs.find(v=>String(v).startsWith('other:'))).replace(/^other:/,'')
      : '';

    // Conditions UI
    const list = el('conds'); list.innerHTML='';
    const isSingleNil = conditions.length===1 && String(conditions[0]?.condition).toUpperCase()==='NIL';
    setNoConditionsUI(isSingleNil);

    const initialConds = isSingleNil
      ? []
      : (conditions.length ? conditions : [{ medications:[{name:'',frequency:''}] }]);

    initialConds.forEach(c=> list.appendChild(condBlock(c)));

    el('addCond').onclick = ()=> {
      if (noConditions) setNoConditionsUI(false);
      list.appendChild(condBlock({ medications:[{name:'',frequency:''}] }));
    };
  }

  (async function boot(){
    const noCondsChip = el('noCondsChip');
    noCondsChip.onclick = ()=> setNoConditionsUI(!noConditions);

    if (!token) {
        el('status').textContent='Missing token. Paste token below to open the portal.';
        el('tokenBlock').style.display = '';
        el('tokenBtn').onclick = () => {
          const v = el('tokenInput').value.trim();
          if (!v) { el('tokenMsg').textContent = 'Enter a token to continue'; return; }
          // reload with token in query string so the normal flow (and localStorage key) works
          location.search = '?token=' + encodeURIComponent(v);
        };
        return;
    }

    let pin = localStorage.getItem('ec_pin_'+token) || '';
    let pinHash = pin ? await sha256Hex(pin) : '';

    let { data, error } = await rpcGet(pinHash);
    if (error && /invalid pin|pin required/i.test(error.message || String(error))) {
      el('status').textContent='This link is protected by a PIN.';
      el('pinBlock').style.display='';
      el('pinUseBtn').onclick = async () => {
        const p = el('pinInput').value.trim();
        if (p.length < 4) { el('pinMsg').textContent='PIN must be 4+ digits'; return; }
        const h = await sha256Hex(p);
        const r = await rpcGet(h);
        if (r.error) { el('pinMsg').textContent = r.error.message || 'Wrong PIN'; return; }
        pin = p; pinHash = h; localStorage.setItem('ec_pin_'+token, pin);
        el('pinBlock').style.display='none'; render(r.data);
      };
      el('pinSetBtn').onclick = async () => {
        const p = el('pinInput').value.trim();
        if (p.length < 4) { el('pinMsg').textContent='PIN must be 4+ digits'; return; }
        const h = await sha256Hex(p);
        const r = await rpcSetPin(h);
        if (r.error) { el('pinMsg').textContent = r.error.message || 'Failed to set PIN'; return; }
        pin = p; pinHash = h; localStorage.setItem('ec_pin_'+token, pin);
        const g = await rpcGet(h); render(g.data);
        el('pinBlock').style.display='none';
      };
      return;
    }

    if (error) { el('status').textContent = error.message || 'Failed to load'; return; }
    el('status').textContent=''; render(data);

    el('saveBtn').onclick = async () => {
      el('saveMsg').textContent='Saving…';

      const list = [...document.querySelectorAll('#conds > .card')];

      let conditions;
      if (noConditions || list.length===0) {
        conditions = [ { ...NIL_COND } ];
      } else {
        conditions = list.map(n=>n._get()).filter(c =>
          c.condition || (c.medications && c.medications.length) || c.doctor || c.clinic || c.appointments
        );
        if (!conditions.length) conditions = [ { ...NIL_COND } ];
      }

      const payload = {
        emergency: {
          name: el('ec_name').value || null,
          relation: el('ec_relation').value || null,
          phone: el('ec_phone').value || null,
          email: el('ec_email').value || null,
        },
        extras: {
          assistive_needs: gatherAssistive(),
          drug_allergies: el('drug_allergies').value || null,
          public_note: el('public_note').value || null,
        },
        conditions
      };

      const storedPin = localStorage.getItem('ec_pin_'+token) || '';
      const h = await sha256Hex(storedPin || '');
      const { error: e } = await rpcSave(h, payload);
      el('saveMsg').textContent = e ? ('Failed: ' + (e.message || '')) : 'Saved!';
    };
  })();
</script>
</body>
</html>
