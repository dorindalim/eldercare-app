<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Emergency Contact Portal</title>
  <style>
    :root{
      --bg:#F8FAFC; --card:#FFFFFF; --muted:#6B7280; --border:#E5E7EB;
      --accent:#111827; --accent-weak:#374151; --pill:#F3F4F6; --radius:14px;
    }
    html,body{height:100%;}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;background:var(--bg);margin:0;color:var(--accent)}
    .wrap{max-width:980px;margin:28px auto;padding:20px}
    .portal-header{display:flex;align-items:center;gap:12px;margin-bottom:18px}
    .logo{width:56px;height:56px;border-radius:12px;background:linear-gradient(135deg,#EFF6FF,#F8FAFC);display:flex;align-items:center;justify-content:center;border:1px solid var(--border);box-shadow:0 6px 18px rgba(2,6,23,0.06)}
    .logo svg{width:34px;height:34px;fill:var(--accent)}
    .hdr-title{display:flex;flex-direction:column;flex:1}
    .hdr-title h1{font-size:20px;margin:0;font-weight:800}
    .hdr-sub{font-size:13px;color:var(--muted);margin-top:4px}
    .hdr-actions{display:flex;gap:8px}
    .btn{background:var(--accent);color:#fff;font-weight:800;border:none;border-radius:10px;padding:10px 14px;cursor:pointer;box-shadow:0 6px 14px rgba(17,24,39,0.12);transition:transform .08s ease,box-shadow .08s ease}
    .btn:active{transform:translateY(1px)}
    .btn.secondary{background:transparent;color:var(--accent);border:1px solid rgba(17,24,39,0.08);box-shadow:none}
    .btn.ghost{background:transparent;border:1px dashed rgba(17,24,39,0.08);color:var(--accent)}
    .card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:18px;margin-bottom:16px;box-shadow:0 6px 18px rgba(2,6,23,0.04)}
    h2{font-size:15px;margin:8px 0 12px;font-weight:800;color:var(--accent)}
    label{display:block;font-weight:700;color:var(--accent-weak);margin:6px 0 6px}
    input,textarea{width:100%;padding:12px;border-radius:10px;border:1px solid #E6E9EE;background:#fbfdff;font-size:14px;color:var(--accent);box-sizing:border-box}
    textarea{min-height:88px}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .chip{border:1px solid #E2E8F0;padding:8px 12px;border-radius:999px;cursor:pointer;user-select:none;font-weight:800;display:inline-block;margin:4px 6px 0 0;background:transparent}
    .chip.active{background:var(--accent);color:#fff;border-color:var(--accent)}
    .medrow{display:flex;gap:8px;margin-top:6px}
    .muted{color:var(--muted);font-size:13px}
    .pin-row{display:flex;gap:8px;align-items:center}
    .pin-wrap{position:relative;flex:1}
    .pin-wrap input{padding-right:44px}
    .eye-btn{position:absolute;right:6px;top:50%;transform:translateY(-50%);border:0;background:transparent;cursor:pointer;padding:6px;border-radius:8px}
    .eye-btn:hover{background:#F3F4F6}
    .remember{display:flex;align-items:center;gap:8px;margin-top:6px;color:var(--accent-weak);font-weight:600}
    @media (max-width:640px){
      .wrap{padding:14px;margin:16px}
      .actions{position:sticky;bottom:12px;background:transparent;padding:6px 0}
      .card:last-of-type{padding-bottom:74px}
    }
    input::placeholder, textarea::placeholder{color:#9CA3AF}
  </style>
</head>
<body>
<div class="wrap">
  <div class="portal-header">
    <div class="logo" aria-hidden>
      <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 2a4 4 0 0 0-4 4v2H6a4 4 0 0 0-4 4v4a4 4 0 0 0 4 4h12a4 4 0 0 0 4-4v-4a4 4 0 0 0-4-4h-2V6a4 4 0 0 0-4-4zM8 8a4 4 0 1 1 8 0v2H8V8z"/></svg>
    </div>
    <div class="hdr-title">
      <h1>Emergency Contact Portal</h1>
      <div class="hdr-sub">Quickly view and update emergency contact &amp; medical details</div>
    </div>
    <div class="hdr-actions">
      <button id="logoutBtn" class="btn secondary" title="Lock / Logout">Logout</button>
    </div>
  </div>

  <div class="card">
    <p class="muted" id="status">Loading…</p>
    <div id="pinBlock" style="display:none">
      <div class="pin-row">
        <div class="pin-wrap">
          <input id="pinInput" placeholder="Enter 4+ digit PIN" type="password" inputmode="numeric" autocomplete="off" />
          <button id="togglePin" class="eye-btn" aria-label="Show/Hide PIN" title="Show/Hide PIN">
            <svg id="eyeOpen" xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24"><path d="M12 5c-7.633 0-11 7-11 7s3.367 7 11 7 11-7 11-7-3.367-7-11-7zm0 12a5 5 0 110-10 5 5 0 010 10z"/></svg>
            <svg id="eyeClosed" xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" style="display:none"><path d="M12 5c-2.61 0-4.822.7-6.65 1.76L3.4 4.81 2 6.22l18 18 1.41-1.41-3.04-3.04C21.036 17.76 23 12 23 12s-3.367-7-11-7zm-2.08 2.08A8.88 8.88 0 0112 7c5.4 0 8.41 3.86 9.39 5-.383.47-1.012 1.16-1.91 1.93l-2.83-2.83A5 5 0 009.92 7.08zM4.52 9.11C3.62 9.88 2.99 10.57 2.61 11.04c.39.47 1.02 1.16 1.91 1.93.84.7 1.87 1.42 3.08 1.98l-1.5 1.5C3.06 14.78 1 12 1 12s1.97-2.81 5.51-4.89z"/></svg>
          </button>
        </div>
        <button id="pinSetBtn" class="btn">Set PIN</button>
        <button id="pinUseBtn" class="btn secondary">Unlock</button>
      </div>
      <label class="remember"><input type="checkbox" id="rememberPin" /> Remember this device</label>
      <p id="pinMsg" class="muted"></p>
    </div>
  </div>

  <div id="main" style="display:none">
    <div class="card">
      <h2>Emergency Contact</h2>
      <label>Name</label><input id="ec_name" />
      <label>Relation</label><input id="ec_relation" />
      <label>Phone</label><input id="ec_phone" />
      <label>Email</label><input id="ec_email" />
    </div>

    <div class="card">
      <h2>Health Card</h2>
      <label>Drug allergy</label><input id="drug_allergies" placeholder="e.g. Penicillin or NIL" />
      <label>Assistive needs</label>
      <div id="assistive"></div>
      <div id="assistive_other_wrap" style="display:none">
        <label>Other</label><input id="assistive_other" placeholder="Type other assistive need" />
      </div>
      <label>Note to public</label><textarea id="public_note" placeholder="If found lost, please call …"></textarea>
    </div>

    <div class="card">
      <h2>Conditions &amp; Medications</h2>
      <div class="row" style="margin-bottom:8px">
        <span id="noCondsChip" class="chip">No conditions</span>
        <span class="muted">Tip: you can still add a condition even if this is on — the form will auto-reappear.</span>
      </div>
      <div id="noCondsNote" class="muted" style="display:none; margin-bottom:8px">
        You marked “No conditions”. We will save a single NIL placeholder. You can still add a condition below.
      </div>
      <div id="conds"></div>
      <button id="addCond" class="btn ghost" style="margin-top:8px">+ Add condition</button>
    </div>

    <div class="card">
      <button id="saveBtn" class="btn">Save changes</button>
      <span id="saveMsg" class="muted" style="margin-left:8px"></span>
    </div>
  </div>
</div>

<script type="module">
  import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

  // ---- CONFIG ----
  const PROJECT_URL = "https://ilwcrkwdmzfwoyjknrkl.supabase.co";
  const ANON_KEY    = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imlsd2Nya3dkbXpmd295amtucmtsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcwNjQ3MTcsImV4cCI6MjA3MjY0MDcxN30.SMXOZoShZ7pNd4fNF8PwyevLj0SjLXALaoF8H8ZwOi4";
  const supabase = createClient(PROJECT_URL, ANON_KEY);

  const token = new URLSearchParams(location.search).get('token') || '';
  const el = id => document.getElementById(id);

  const assistiveKeys = ['walking_cane','wheelchair','hearing_aid','glasses','other'];
  const labels = { walking_cane:'Walking Cane', wheelchair:'Wheelchair', hearing_aid:'Hearing Aid', glasses:'Glasses', other:'Other' };

  const NIL_MED  = { name:'NIL', frequency:'NIL' };
  const NIL_COND = { condition:'NIL', doctor:'NIL', clinic:'NIL', appointments:'NIL', medications:[{...NIL_MED}] };

  let noConditions = false;
  let cachedPin = '';

  // ---- Diagnostics helper ----
  function showRpcError(where, err) {
    const m = `[${where}] code=${err?.code ?? '—'} | message=${err?.message ?? '—'} | details=${err?.details ?? '—'} | hint=${err?.hint ?? '—'}`;
    console.error(m, err);
    const s = el('status'); if (s) s.textContent = m;
  }

  // ---- UI helpers ----
  function chip(parent, key, active) {
    const span = document.createElement('span');
    span.className = 'chip' + (active ? ' active':'');
    span.textContent = labels[key];
    span.onclick = () => {
      span.classList.toggle('active');
      if (key==='other') {
        const wrap = el('assistive_other_wrap');
        if (wrap) wrap.style.display = span.classList.contains('active') ? '' : 'none';
      }
    };
    parent.appendChild(span);
  }

  function medRow(m={name:'',frequency:''}) {
    const row = document.createElement('div');
    row.className='medrow';
    const n = document.createElement('input'); n.placeholder='Medication name'; n.value=m.name||'';
    const f = document.createElement('input'); f.placeholder='Frequency (e.g., 1 tab AM/PM)'; f.value=m.frequency||'';
    const rm= document.createElement('button'); rm.textContent='Remove'; rm.className='btn secondary'; rm.onclick=()=>row.remove();
    row.append(n,f,rm);
    return row;
  }

  function condBlock(c={condition:'',doctor:'',clinic:'',appointments:'', medications:[{name:'',frequency:''}]}) {
    const wrap = document.createElement('div'); wrap.className='card';
    const t=document.createElement('input'); t.placeholder='Condition (e.g., Diabetes)'; t.value=c.condition||'';
    const d=document.createElement('input'); d.placeholder='Doctor'; d.value=c.doctor||'';
    const cl=document.createElement('input'); cl.placeholder='Clinic/Hospital'; cl.value=c.clinic||'';
    const ap=document.createElement('textarea'); ap.placeholder='Appointment notes'; ap.value=c.appointments||'';

    const togglesRow = document.createElement('div'); togglesRow.className='row';
    const noMedsChip = document.createElement('span'); noMedsChip.className='chip'; noMedsChip.textContent='No medications for this condition';
    togglesRow.appendChild(noMedsChip);

    const medsLabel=document.createElement('label'); medsLabel.textContent='Medications';
    const medsWrap=document.createElement('div');
    const addMedBtn = document.createElement('button');
    addMedBtn.className = 'btn ghost';
    addMedBtn.textContent = '+ Add medication';
    addMedBtn.style.marginTop = '6px';
    addMedBtn.onclick = () => medsWrap.appendChild(medRow({name:'',frequency:''}));

    const initialNoMeds =
      Array.isArray(c.medications) &&
      c.medications.length===1 &&
      String(c.medications[0]?.name).toUpperCase()==='NIL';

    if (c.medications?.length && !initialNoMeds) {
      c.medications.forEach(m=> medsWrap.appendChild(medRow(m)));
    } else if (!initialNoMeds) {
      medsWrap.appendChild(medRow({name:'',frequency:''}));
    }

    function setNoMeds(on) {
      if (on) {
        noMedsChip.classList.add('active');
        medsLabel.style.display='none';
        medsWrap.style.display='none';
        addMedBtn.style.display='none';
      } else {
        noMedsChip.classList.remove('active');
        medsLabel.style.display='';
        medsWrap.style.display='';
        addMedBtn.style.display='';
        if (medsWrap.children.length===0) medsWrap.appendChild(medRow({name:'',frequency:''}));
      }
    }
    setNoMeds(initialNoMeds);
    noMedsChip.onclick = ()=> setNoMeds(!noMedsChip.classList.contains('active'));

    const rmC=document.createElement('button'); rmC.textContent='Remove condition'; rmC.className='btn secondary'; rmC.style.marginTop='6px'; rmC.onclick=()=>wrap.remove();

    wrap.append(t,d,cl,ap,togglesRow,medsLabel,medsWrap,addMedBtn,rmC);

    wrap._get=()=>({
      condition: t.value.trim()||null,
      doctor: d.value.trim()||null,
      clinic: cl.value.trim()||null,
      appointments: ap.value.trim()||null,
      medications: noMedsChip.classList.contains('active')
        ? [{...NIL_MED}]
        : [...medsWrap.children].map(r=>{
            const [n,f]=r.querySelectorAll('input');
            const name=(n.value||'').trim();
            const frequency=(f.value||'').trim();
            return name ? { name, frequency: (frequency||null) } : null;
          }).filter(Boolean)
    });

    return wrap;
  }

  function addCondition() {
    if (noConditions) setNoConditionsUI(false);
    const list = el('conds');
    if (list) list.appendChild(condBlock({ medications:[{name:'',frequency:''}] }));
  }

  function setNoConditionsUI(on) {
    noConditions = !!on;
    el('noCondsNote').style.display = on ? '' : 'none';
    el('conds').style.display = on ? 'none' : '';
    el('noCondsChip').classList.toggle('active', on);
  }

  function gatherAssistive() {
    const picks = [...document.querySelectorAll('#assistive .chip.active')].map(ch=>{
      const label = ch.textContent;
      const key = Object.entries(labels).find(([,v])=>v===label)?.[0] || label;
      return key;
    });
    if (picks.includes('other')) {
      const otherEl = el('assistive_other');
      const other = otherEl ? (otherEl.value||'').trim() : '';
      if (other) picks.push('other:'+other);
      return picks.filter(p=>p!=='other');
    }
    return picks;
  }

  function getEmergency(profile = {}) {
    if (profile.emergency && typeof profile.emergency === 'object') {
      const e = profile.emergency;
      return { name:e.name??'', relation:e.relation??'', phone:e.phone??'', email:e.email??'' };
    }
    return {
      name: profile.emergency_name ?? '',
      relation: profile.emergency_relation ?? '',
      phone: profile.emergency_phone ?? '',
      email: profile.emergency_email ?? ''
    };
  }

  async function rpcGet(pinHash) {
    const { data, error } = await supabase.rpc('ec_get_portal', {
      p_token: token,
      p_pin_hash: pinHash ?? null   // <— NULL when missing
    });
    return { data, error };
  }

  async function rpcSave(pinHash, payload) {
    const { data, error } = await supabase.rpc('ec_save_portal', {
      p_token: token,
      p_pin_hash: pinHash ?? null,  // <— NULL when missing
      p_emergency: payload.emergency,
      p_extras: payload.extras,
      p_conditions: payload.conditions
    });
    return { data, error }; // returns void (204) on success
  }

  async function rpcSetPin(pinHash) {
    const { data, error } = await supabase.rpc('ec_set_pin', {
      p_token: token,
      p_pin_hash: pinHash            // <— always a string here
    });
    return { data, error };
  }

  function showPinUI(msg='This link is protected by a PIN.') {
    el('status').textContent = msg;
    el('pinBlock').style.display = '';
    el('main').style.display = 'none';
    el('pinMsg').textContent = '';
  }
  function showMainUI() {
    el('status').textContent = '';
    el('pinBlock').style.display = 'none';
    el('main').style.display = '';
  }
  function logout() {
    try { localStorage.removeItem('ec_pin_'+token); } catch {}
    cachedPin = '';
    ['ec_name','ec_relation','ec_phone','ec_email','drug_allergies','public_note','assistive_other'].forEach(id=>{
      const x=el(id); if (x) x.value = '';
    });
    const conds = el('conds'); if (conds) conds.innerHTML='';
    setNoConditionsUI(false);
    showPinUI('Locked. Please enter PIN to continue.');
  }

  function render(resp) {
    const payload    = Array.isArray(resp) ? (resp[0] || {}) : (resp || {});
    const profile    = payload.profile || {};
    const conditions = Array.isArray(payload.conditions) ? payload.conditions : [];

    const em = getEmergency(profile);
    el('ec_name').value     = em.name || '';
    el('ec_relation').value = em.relation || '';
    el('ec_phone').value    = em.phone || '';
    el('ec_email').value    = em.email || '';

    el('drug_allergies').value = profile.drug_allergies || '';
    el('public_note').value    = profile.public_note || '';

    const needs = Array.isArray(profile.assistive_needs) ? profile.assistive_needs : [];
    const showOther = needs.some(v=>String(v).startsWith('other:'));
    const assistDiv = el('assistive'); assistDiv.innerHTML='';
    assistiveKeys.forEach(k=>{
      const active = k==='other' ? showOther : needs.includes(k);
      chip(assistDiv, k, active);
    });
    el('assistive_other_wrap').style.display = showOther ? '' : 'none';
    el('assistive_other').value = showOther
      ? String(needs.find(v=>String(v).startsWith('other:'))).replace(/^other:/,'')
      : '';

    const list = el('conds'); list.innerHTML='';
    const isSingleNil = conditions.length===1 && String(conditions[0]?.condition).toUpperCase()==='NIL';
    setNoConditionsUI(isSingleNil);
    const initialConds = isSingleNil ? [] : (conditions.length ? conditions : [{ medications:[{name:'',frequency:''}] }]);
    initialConds.forEach(c=> list.appendChild(condBlock(c)));
  }

  function wirePinEye() {
    const pin = el('pinInput');
    const eyeOpen = document.getElementById('eyeOpen');
    const eyeClosed = document.getElementById('eyeClosed');
    el('togglePin').onclick = () => {
      const showing = pin.type === 'text';
      pin.type = showing ? 'password' : 'text';
      eyeOpen.style.display = showing ? '' : 'none';
      eyeClosed.style.display = showing ? 'none' : '';
    };
  }

  (async function boot(){
    el('logoutBtn').onclick = logout;
    const addBtn = el('addCond'); if (addBtn) addBtn.addEventListener('click', addCondition);
    el('noCondsChip').onclick = ()=> setNoConditionsUI(!noConditions);
    wirePinEye();

    if (!token) { el('status').textContent='Missing token'; return; }

    // Try a remembered PIN first
    let data = null;
    let error = null;
    let storedPin = '';
    try { storedPin = localStorage.getItem('ec_pin_'+token) || ''; } catch (e) { /* ignore */ }

    if (storedPin) {
      const h = await sha256Hex(storedPin);
      const res = await rpcGet(h);
      if (!res.error) {
        data = res.data;
        cachedPin = storedPin;
      } else if (!/invalid pin|pin required/i.test(res.error?.message || '')) {
        showRpcError('rpcGet(cached)', res.error);
      }
    }

    // If cached pin didn’t work, try without pin to detect if the link is open
    if (data === null) {
      const res2 = await rpcGet(null);
      data = res2.data;
      error = res2.error;
      if (error && !/invalid pin|pin required|invalid token/i.test(error?.message || '')) {
        showRpcError('rpcGet(open)', error);
      }
    }

    if (error && /invalid pin|pin required/i.test(error.message || '')) {
      showPinUI('This link is protected by a PIN.');
      el('pinUseBtn').onclick = async () => {
        const p = (el('pinInput').value||'').trim();
        if (p.length < 4) { el('pinMsg').textContent='PIN must be 4+ digits'; return; }
        const h = await sha256Hex(p);
        const r = await rpcGet(h);
        if (r.error) { el('pinMsg').textContent = r.error.message || 'Wrong PIN'; return; }
        cachedPin = p;
        if (el('rememberPin').checked) {
          try { localStorage.setItem('ec_pin_'+token, p); } catch {}
        }
        showMainUI(); render(r.data);
      };
      el('pinSetBtn').onclick = async () => {
        const p = (el('pinInput').value||'').trim();
        if (p.length < 4) { el('pinMsg').textContent='PIN must be 4+ digits'; return; }
        const h = await sha256Hex(p);
        const r = await rpcSetPin(h);
        if (r.error) { el('pinMsg').textContent = r.error.message || 'Failed to set PIN'; return; }
        cachedPin = p;
        if (el('rememberPin').checked) {
          try { localStorage.setItem('ec_pin_'+token, p); } catch {}
        }
        const g = await rpcGet(h);
        if (g.error) { showRpcError('rpcGet(after set pin)', g.error); return; }
        showMainUI(); render(g.data);
      };
      return;
    } else if (error && /invalid token/i.test(error.message || '')) {
      el('status').textContent = 'This link is invalid or has been revoked.'; return;
    } else if (error) {
      showRpcError('rpcGet', error);
      return;
    }

    // Optional: block if deletion scheduled
    try {
      const payloadCheck = Array.isArray(data) ? (data[0] || {}) : (data || {});
      const profileCheck = payloadCheck.profile || {};
      const scheduled_for = profileCheck.scheduled_for || null;
      const deletion_status = profileCheck.deletion_status || null;
      const scheduledDate = scheduled_for ? new Date(scheduled_for) : null;
      const now = new Date();
      const pendingDeletion = deletion_status === 'deletion_scheduled' || (scheduledDate && scheduledDate > now);
      if (pendingDeletion) {
        el('status').textContent = 'This account is scheduled for deletion. The portal is disabled.';
        el('pinBlock').style.display = 'none';
        el('main').style.display = 'none';
        return;
      }
    } catch (e) {
      console.warn('deletion check failed', e);
    }

    showMainUI();
    render(data);

    el('saveBtn').onclick = async () => {
      el('saveMsg').textContent='Saving…';
      const list = [...document.querySelectorAll('#conds > .card')];
      let conditions;
      if (noConditions || list.length===0) {
        conditions = [ { ...NIL_COND } ];
      } else {
        conditions = list.map(n=>n._get()).filter(c =>
          c.condition || (c.medications && c.medications.length) || c.doctor || c.clinic || c.appointments
        );
        if (!conditions.length) conditions = [ { ...NIL_COND } ];
      }

      const payload = {
        emergency: {
          name: el('ec_name').value || null,
          relation: el('ec_relation').value || null,
          phone: el('ec_phone').value || null,
          email: el('ec_email').value || null,
        },
        extras: {
          assistive_needs: gatherAssistive(),
          drug_allergies: el('drug_allergies').value || null,
          public_note: el('public_note').value || null,
        },
        conditions
      };

      if (!cachedPin) {
        try { cachedPin = localStorage.getItem('ec_pin_'+token) || ''; } catch {}
      }
      const h = cachedPin ? await sha256Hex(cachedPin) : null;

      const { error: e } = await rpcSave(h, payload);
      if (e) {
        showRpcError('rpcSave', e);
        el('saveMsg').textContent = 'Failed';
      } else {
        el('saveMsg').textContent = 'Saved!';
      }
    };
  })();

  async function sha256Hex(s) {
    const b = new TextEncoder().encode(s);
    const h = await crypto.subtle.digest('SHA-256', b);
    return [...new Uint8Array(h)].map(x=>x.toString(16).padStart(2,'0')).join('');
  }

  window.onerror = (msg, src, line, col) => {
    const s = el('status'); if (s) s.textContent = 'Error: ' + msg + ' (' + line + ':' + col + ')';
  };
</script>
</body>
</html>
