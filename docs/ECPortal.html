<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Emergency Contact Portal</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto; background:#f8fafc; margin:0}
    .wrap{max-width:880px; margin:0 auto; padding:16px}
    .card{background:#fff; border:1px solid #e5e7eb; border-radius:14px; padding:16px; margin-bottom:12px}
    h1{font-size:20px; margin:0 0 8px; font-weight:800; color:#111827}
    h2{font-size:16px; margin:12px 0 8px; font-weight:800; color:#111827}
    label{display:block; font-weight:700; color:#374151; margin:6px 0 4px}
    input,textarea{width:100%; padding:10px; border-radius:8px; border:1px solid #d1d5db; background:#f9fafb; font-size:14px; color:#111827}
    textarea{min-height:72px}
    .row{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
    .btn{background:#111827; color:#fff; font-weight:800; border:none; border-radius:10px; padding:10px 14px; cursor:pointer}
    .btn.secondary{background:#fff; color:#111827; border:1px solid #111827}
    .chip{border:1px solid #d1d5db; padding:8px 12px; border-radius:999px; cursor:pointer; user-select:none; font-weight:800; display:inline-block; margin:4px 6px 0 0}
    .chip.active{background:#111827; color:#fff; border-color:#111827}
    .medrow{display:flex; gap:8px; margin-top:6px}
    .ghost{background:transparent; border:1px dashed #111827; color:#111827}
    .muted{color:#6b7280; font-size:12px}
  </style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>Emergency Contact Portal</h1>
    <p class="muted" id="status">Loading…</p>
    <div id="pinBlock" style="display:none">
      <div style="display:flex; gap:8px; align-items:center">
        <input id="pinInput" placeholder="Enter 4+ digit PIN" />
        <button id="pinSetBtn" class="btn">Set PIN</button>
        <button id="pinUseBtn" class="btn secondary">Unlock</button>
      </div>
      <p id="pinMsg" class="muted"></p>
    </div>
  </div>

  <div id="main" style="display:none">
    <div class="card">
      <h2>Emergency Contact</h2>
      <label>Name</label><input id="ec_name" />
      <label>Relation</label><input id="ec_relation" />
      <label>Phone</label><input id="ec_phone" />
      <label>Email</label><input id="ec_email" />
    </div>

    <div class="card">
      <h2>Health Card</h2>
      <label>Drug allergy</label><input id="drug_allergies" placeholder="e.g. Penicillin or NIL" />
      <label>Assistive needs</label>
      <div id="assistive"></div>
      <div id="assistive_other_wrap" style="display:none">
        <label>Other</label><input id="assistive_other" placeholder="Type other assistive need" />
      </div>
      <label>Note to public</label><textarea id="public_note" placeholder="If found lost, please call …"></textarea>
    </div>

    <div class="card">
      <h2>Conditions & Medications</h2>

      <div class="row" style="margin-bottom:8px">
        <span id="noCondsChip" class="chip">No conditions</span>
        <span class="muted">Tip: you can still add a condition even if this is on — the form will auto-reappear.</span>
      </div>

      <div id="noCondsNote" class="muted" style="display:none; margin-bottom:8px">
        You marked “No conditions”. We will save a single NIL placeholder. You can still add a condition below.
      </div>

      <div id="conds"></div>

      <button id="addCond" class="btn ghost" style="margin-top:8px">+ Add condition</button>
    </div>

    <div class="card">
      <button id="saveBtn" class="btn">Save changes</button>
      <span id="saveMsg" class="muted" style="margin-left:8px"></span>
    </div>
  </div>
</div>

<script type="module">
  import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

  // Show JS errors in the UI so it's easier to spot issues
  window.addEventListener("error", function (e) {
    var s = document.getElementById("status");
    if (s) s.textContent = "Error: " + (e && e.message ? e.message : String(e));
  });

  // --- Supabase init ---
  var PROJECT_URL = "https://ilwcrkwdmzfwoyjknrkl.supabase.co";
  var ANON_KEY    = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imlsd2Nya3dkbXpmd295amtucmtsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcwNjQ3MTcsImV4cCI6MjA3MjY0MDcxN30.SMXOZoShZ7pNd4fNF8PwyevLj0SjLXALaoF8H8ZwOi4";
  var supabase = createClient(PROJECT_URL, ANON_KEY);

  // --- Helpers & constants ---
  var params = new URLSearchParams(location.search);
  var token = params.get('token') || '';
  var assistiveKeys = ['walking_cane','wheelchair','hearing_aid','glasses','other'];
  var labels = { walking_cane:'Walking Cane', wheelchair:'Wheelchair', hearing_aid:'Hearing Aid', glasses:'Glasses', other:'Other' };

  function el(id){ return document.getElementById(id); }
  var NIL_MED = { name:'NIL', frequency:'NIL' };
  var NIL_COND = { condition:'NIL', doctor:'NIL', clinic:'NIL', appointments:'NIL', medications:[{name:'NIL',frequency:'NIL'}] };

  var noConditions = false; // global toggle

  function chip(parent, key, active) {
    var span = document.createElement('span');
    span.className = 'chip' + (active ? ' active':'');
    span.textContent = labels[key];
    span.onclick = function(){
      span.classList.toggle('active');
      if (key==='other') {
        var ow = document.getElementById('assistive_other_wrap');
        if (ow) ow.style.display = span.classList.contains('active') ? '' : 'none';
      }
    };
    parent.appendChild(span);
  }

  function medRow(m){
    if (!m) m = {name:'',frequency:''};
    var row = document.createElement('div');
    row.className='medrow';
    var n = document.createElement('input'); n.placeholder='Medication name'; n.value=m.name||'';
    var f = document.createElement('input'); f.placeholder='Frequency (e.g., 1 tab AM/PM)'; f.value=m.frequency||'';
    var rm= document.createElement('button'); rm.textContent='Remove'; rm.className='btn secondary'; rm.onclick=function(){ row.remove(); };
    row.appendChild(n); row.appendChild(f); row.appendChild(rm);
    return row;
  }

  // Per-condition block (includes per-condition "No medications" toggle)
  function condBlock(c){
    if (!c) c = {condition:'',doctor:'',clinic:'',appointments:'', medications:[{name:'',frequency:''}]};

    var wrap = document.createElement('div'); wrap.className='card';

    var t=document.createElement('input'); t.placeholder='Condition (e.g., Diabetes)'; t.value=c.condition||'';
    var d=document.createElement('input'); d.placeholder='Doctor'; d.value=c.doctor||'';
    var cl=document.createElement('input'); cl.placeholder='Clinic/Hospital'; cl.value=c.clinic||'';
    var ap=document.createElement('textarea'); ap.placeholder='Appointment notes'; ap.value=c.appointments||'';

    var togglesRow = document.createElement('div'); togglesRow.className='row';
    var noMedsChip = document.createElement('span'); noMedsChip.className='chip'; noMedsChip.textContent='No medications for this condition';
    togglesRow.appendChild(noMedsChip);

    var medsLabel=document.createElement('label'); medsLabel.textContent='Medications';
    var medsWrap=document.createElement('div');

    var initialNoMeds = (c.medications && c.medications.length===1 &&
                         String((c.medications[0]||{}).name).toUpperCase()==='NIL');

    if (c.medications && c.medications.length) {
      for (var i=0;i<c.medications.length;i++){
        var m = c.medications[i];
        if (!initialNoMeds) medsWrap.appendChild(medRow(m));
      }
    } else {
      medsWrap.appendChild(medRow({name:'',frequency:''}));
    }

    function setNoMeds(on){
      if (on) {
        noMedsChip.classList.add('active');
        medsLabel.style.display='none';
        medsWrap.style.display='none';
      } else {
        noMedsChip.classList.remove('active');
        medsLabel.style.display='';
        medsWrap.style.display='';
        if (medsWrap.children.length===0) medsWrap.appendChild(medRow({name:'',frequency:''}));
      }
    }
    setNoMeds(initialNoMeds);
    noMedsChip.onclick = function(){ setNoMeds(!noMedsChip.classList.contains('active')); };

    var rmC=document.createElement('button'); rmC.textContent='Remove condition';
    rmC.className='btn secondary'; rmC.style.marginTop='6px'; rmC.onclick=function(){ wrap.remove(); };

    wrap.appendChild(t); wrap.appendChild(d); wrap.appendChild(cl); wrap.appendChild(ap);
    wrap.appendChild(togglesRow); wrap.appendChild(medsLabel); wrap.appendChild(medsWrap); wrap.appendChild(rmC);

    wrap._get=function(){
      var meds = [];
      if (noMedsChip.classList.contains('active')) {
        meds = [{ name:'NIL', frequency:'NIL' }];
      } else {
        var rows = medsWrap.children;
        for (var j=0;j<rows.length;j++){
          var inputs = rows[j].getElementsByTagName('input');
          var n = (inputs[0] && inputs[0].value ? inputs[0].value.trim() : '');
          var f = (inputs[1] && inputs[1].value ? inputs[1].value.trim() : '');
          if (n) meds.push({ name: n, frequency: f || null });
        }
      }
      return {
        condition: t.value.trim()||null,
        doctor: d.value.trim()||null,
        clinic: cl.value.trim()||null,
        appointments: ap.value.trim()||null,
        medications: meds
      };
    };

    return wrap;
  }

  function sha256Hex(s){
    return crypto.subtle.digest('SHA-256', new TextEncoder().encode(s))
      .then(function(h){ return Array.from(new Uint8Array(h)).map(function(x){return x.toString(16).padStart(2,'0');}).join(''); });
  }

  // --- RPC wrappers ---
  function rpcGet(pinHash){ return supabase.rpc('ec_get_portal', { p_token: token, p_pin_hash: pinHash }); }
  function rpcSetPin(pinHash){ return supabase.rpc('ec_set_pin', { p_token: token, p_pin_hash: pinHash }); }
  function rpcSave(pinHash, payload){
    return supabase.rpc('ec_save_portal', {
      p_token: token,
      p_pin_hash: pinHash,
      p_emergency: payload.emergency,
      p_extras: payload.extras,
      p_conditions: payload.conditions
    });
  }

  // ---- Robust finders (no optional chaining)
  function findObjWithEmergencyKeys(obj){
    var keys = ['emergency_name','emergency_relation','emergency_phone','emergency_email'];
    var found = null;
    function walk(o, depth){
      if (found) return;
      if (depth > 6) return;
      if (!o || typeof o !== 'object') return;

      var hasAny = false;
      for (var i=0;i<keys.length;i++){
        if (Object.prototype.hasOwnProperty.call(o, keys[i])) { hasAny = true; break; }
      }
      if (hasAny) { found = o; return; }

      if (Array.isArray(o)) {
        for (var a=0;a<o.length;a++) walk(o[a], depth+1);
      } else {
        var vals = Object.keys(o);
        for (var k=0;k<vals.length;k++) walk(o[vals[k]], depth+1);
      }
    }
    walk(obj, 0);
    return found || {};
  }

  function findConditionsArray(obj){
    var out = null;
    function walk(o, depth){
      if (out) return;
      if (depth > 6) return;
      if (!o || typeof o !== 'object') return;

      if (Array.isArray(o) && o.length && typeof o[0] === 'object' && o[0] !== null && Object.prototype.hasOwnProperty.call(o[0], 'condition')) {
        out = o; return;
      }

      if (Array.isArray(o)) {
        for (var a=0;a<o.length;a++) walk(o[a], depth+1);
      } else {
        var vals = Object.keys(o);
        for (var k=0;k<vals.length;k++) walk(o[vals[k]], depth+1);
      }
    }
    walk(obj, 0);
    return out;
  }

  function setNoConditionsUI(on){
    noConditions = !!on;
    var note = el('noCondsNote');
    var list = el('conds');
    if (note) note.style.display = on ? '' : 'none';
    if (list) list.style.display = on ? 'none' : '';
    var chip = el('noCondsChip');
    if (chip) chip.classList.toggle('active', on);
  }

  function render(resp){
    console.log('RPC payload:', resp);
    var status = el('status');
    if (status) status.textContent = '';
    var main = el('main');
    if (main) main.style.display = '';

    // 1) Profile row with emergency_* fields
    var profile = findObjWithEmergencyKeys(resp);

    el('ec_name').value     = profile.emergency_name     ? String(profile.emergency_name) : '';
    el('ec_relation').value = profile.emergency_relation ? String(profile.emergency_relation) : '';
    el('ec_phone').value    = profile.emergency_phone    ? String(profile.emergency_phone) : '';
    el('ec_email').value    = profile.emergency_email    ? String(profile.emergency_email) : '';

    // 2) Extras
    el('drug_allergies').value = profile.drug_allergies ? String(profile.drug_allergies) : '';
    el('public_note').value    = profile.public_note ? String(profile.public_note) : '';
    var raw = (profile.assistive_needs && Array.isArray(profile.assistive_needs)) ? profile.assistive_needs : [];
    var showOther = false;
    for (var i=0;i<raw.length;i++){ if (String(raw[i]).indexOf('other:')===0) { showOther = true; break; } }
    var assistDiv = el('assistive'); if (assistDiv) assistDiv.innerHTML='';
    for (var j=0;j<assistiveKeys.length;j++){
      var k = assistiveKeys[j];
      var active = (k==='other') ? showOther : (raw.indexOf(k) >= 0);
      chip(assistDiv, k, active);
    }
    var otherWrap = el('assistive_other_wrap');
    if (otherWrap) otherWrap.style.display = showOther ? '' : 'none';
    var otherInput = el('assistive_other');
    if (otherInput) {
      var otherVal = '';
      for (var r=0;r<raw.length;r++){
        if (String(raw[r]).indexOf('other:')===0) { otherVal = String(raw[r]).replace(/^other:/,''); break; }
      }
      otherInput.value = otherVal;
    }

    // 3) Conditions
    var list = el('conds'); if (list) list.innerHTML='';
    var incoming = findConditionsArray(resp);

    var isSingleNil = false;
    if (incoming && incoming.length===1) {
      var c0 = incoming[0] || {};
      if (String(c0.condition || '').toUpperCase() === 'NIL') isSingleNil = true;
    }

    setNoConditionsUI(isSingleNil);

    var initialConds = [];
    if (!isSingleNil) {
      if (incoming && incoming.length) initialConds = incoming;
      else initialConds = [{ medications:[{name:'',frequency:''}] }];
    }

    for (var m=0;m<initialConds.length;m++){
      list.appendChild(condBlock(initialConds[m]));
    }

    el('addCond').onclick = function(){
      if (noConditions) setNoConditionsUI(false);
      list.appendChild(condBlock({ medications:[{name:'',frequency:''}] }));
    };
  }

  // --- Boot ---
  (function boot(){
    var noCondsChip = el('noCondsChip');
    if (noCondsChip) noCondsChip.onclick = function(){ setNoConditionsUI(!noConditions); };

    if (!token) { var st = el('status'); if (st) st.textContent='Missing token in URL'; return; }

    // try cached pin
    var pin = localStorage.getItem('ec_pin_'+token) || '';
    sha256Hex(pin).then(function(pinHash){
      return rpcGet(pinHash);
    }).then(function(res){
      var data = res && res.data;
      var error = res && res.error;
      if (error && /invalid pin|pin required/i.test(error.message || String(error))) {
        var status = el('status'); if (status) status.textContent='This link is protected by a PIN.';
        var pinBlock = el('pinBlock'); if (pinBlock) pinBlock.style.display='';
        el('pinUseBtn').onclick = function(){
          var p = el('pinInput').value.trim();
          var msg = el('pinMsg');
          if (p.length < 4) { if (msg) msg.textContent='PIN must be 4+ digits'; return; }
          sha256Hex(p).then(function(h){
            return rpcGet(h).then(function(r){
              if (r.error) { if (msg) msg.textContent = r.error.message || 'Wrong PIN'; return; }
              localStorage.setItem('ec_pin_'+token, p);
              el('pinBlock').style.display='none';
              render(r.data);
            });
          });
        };
        el('pinSetBtn').onclick = function(){
          var p = el('pinInput').value.trim();
          var msg = el('pinMsg');
          if (p.length < 4) { if (msg) msg.textContent='PIN must be 4+ digits'; return; }
          sha256Hex(p).then(function(h){
            return rpcSetPin(h).then(function(r){
              if (r.error) { if (msg) msg.textContent = r.error.message || 'Failed to set PIN'; return; }
              localStorage.setItem('ec_pin_'+token, p);
              return rpcGet(h).then(function(g){
                el('pinBlock').style.display='none';
                render(g.data);
              });
            });
          });
        };
        return;
      }
      if (error) { var st2 = el('status'); if (st2) st2.textContent = (error.message || 'Failed to load'); return; }
      var st3 = el('status'); if (st3) st3.textContent='';
      render(data);
    }).catch(function(err){
      var st = el('status'); if (st) st.textContent = 'Load failed: ' + (err && err.message ? err.message : String(err));
      console.error('Boot error:', err);
    });

    // save handler
    el('saveBtn').onclick = function(){
      el('saveMsg').textContent='Saving…';

      var list = document.querySelectorAll('#conds > .card');

      var conditions;
      if (noConditions || list.length===0) {
        conditions = [ { condition:'NIL', doctor:'NIL', clinic:'NIL', appointments:'NIL', medications:[{name:'NIL',frequency:'NIL'}] } ];
      } else {
        conditions = [];
        for (var i=0;i<list.length;i++){
          var node = list[i];
          if (node && typeof node._get === 'function') {
            var c = node._get();
            if (c && (c.condition || (c.medications && c.medications.length) || c.doctor || c.clinic || c.appointments)) {
              conditions.push(c);
            }
          }
        }
        if (!conditions.length) conditions = [ { condition:'NIL', doctor:'NIL', clinic:'NIL', appointments:'NIL', medications:[{name:'NIL',frequency:'NIL'}] } ];
      }

      var payload = {
        emergency: {
          name: el('ec_name').value || null,
          relation: el('ec_relation').value || null,
          phone: el('ec_phone').value || null,
          email: el('ec_email').value || null,
        },
        extras: {
          assistive_needs: (function(){
            var picks = [];
            var chips = document.querySelectorAll('#assistive .chip');
            for (var k=0;k<chips.length;k++){
              var ch = chips[k];
              if (ch.classList.contains('active')) {
                var label = ch.textContent;
                var key = null;
                var entries = Object.keys(labels);
                for (var e=0;e<entries.length;e++){
                  if (labels[entries[e]] === label) { key = entries[e]; break; }
                }
                picks.push(key || label);
              }
            }
            // append "other:..." value if present
            if (picks.indexOf('other') >= 0) {
              var other = el('assistive_other').value.trim();
              if (other) picks.push('other:'+other);
              // remove raw 'other' marker
              picks = picks.filter(function(p){ return p !== 'other'; });
            }
            return picks;
          })(),
          drug_allergies: el('drug_allergies').value || null,
          public_note: el('public_note').value || null,
        },
        conditions: conditions
      };

      var pin = localStorage.getItem('ec_pin_'+token) || '';
      sha256Hex(pin || '').then(function(h){
        return rpcSave(h, payload);
      }).then(function(res){
        var e = res && res.error;
        el('saveMsg').textContent = e ? ('Failed: ' + (e.message || '')) : 'Saved!';
      }).catch(function(err){
        el('saveMsg').textContent = 'Failed: ' + (err && err.message ? err.message : String(err));
      });
    };
  })();
</script>
</body>
</html>
